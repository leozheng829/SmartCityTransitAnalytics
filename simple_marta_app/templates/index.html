<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple MARTA Transit Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container mt-5">
        <header class="text-center mb-5">
            <h1 class="display-4">MARTA Transit Dashboard</h1>
            <p class="lead">Real-time transit information for Atlanta</p>
            <button id="refreshBtn" class="btn btn-primary">Refresh Data</button>
        </header>

        <div class="row mb-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Weather in <span id="city">Atlanta</span></h5>
                        <h2 id="temperature">--°F</h2>
                        <p id="conditions">Loading weather data...</p>
                        <p>Feels like: <span id="feelsLike">--</span>°F</p>
                        <p>Humidity: <span id="humidity">--</span>%</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Bus Status</h5>
                        <h2 id="busStatus">--</h2>
                        <p id="busDetails">Loading bus status...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Train Status</h5>
                        <h2 id="trainStatus">--</h2>
                        <p id="trainDetails">Loading train status...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Transit Map</h5>
                        <div class="btn-group mt-2">
                            <button class="btn btn-sm btn-outline-primary active" id="showBuses">Bus View</button>
                            <button class="btn btn-sm btn-outline-primary" id="showTrains">Train View</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="transitMap">
                            <div id="busView" class="simple-map">
                                <div id="busMapContent" class="text-center p-3">
                                    <h3>Bus Positions</h3>
                                    <p>Showing latest bus positions</p>
                                    
                                    <!-- Bus Map Container -->
                                    <div class="marta-map-container mb-4">
                                        <div id="busPositionsMap" class="map-container"></div>
                                    </div>
                                    
                                    <h4 class="mt-4">Bus Details</h4>
                                    <div id="busPositions" class="row"></div>
                                    
                                    <h4 class="mt-4">Recent Trip Updates</h4>
                                    <div id="busTripUpdates" class="row"></div>
                                </div>
                            </div>
                            
                            <div id="trainView" class="simple-map" style="display:none;">
                                <div id="trainMapContent" class="text-center p-3">
                                    <h3>MARTA Train Map</h3>
                                    <p>Showing latest train positions</p>
                                    <div class="marta-map-container">
                                        <div id="trainPositionsMap" class="map-container"></div>
                                    </div>
                                    <div id="trainPositions" class="row mt-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Updates</h5>
                        <button id="refreshUpdates" class="btn btn-sm btn-outline-primary">Refresh</button>
                    </div>
                    <div class="card-body">
                        <ul id="recentUpdates" class="list-group list-group-flush">
                            <li class="list-group-item">Loading updates...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Map of MARTA train stations and their coordinates on the map image
        // These are estimated positions based on the map image proportion
        const stationPositions = {
            // Red Line stations (North-South)
            'NORTH SPRINGS': { top: 0, left: 48, line: 'RED' },
            'SANDY SPRINGS': { top: 8, left: 48, line: 'RED' },
            'DUNWOODY': { top: 16, left: 48, line: 'RED' },
            'MEDICAL CENTER': { top: 24, left: 48, line: 'RED' },
            'BUCKHEAD': { top: 31, left: 48, line: 'RED' },
            'LINDBERGH CENTER': { top: 39, left: 48, line: 'RED' },
            
            // Gold Line stations (North-South)
            'DORAVILLE': { top: 0, left: 62, line: 'GOLD' },
            'CHAMBLEE': { top: 8, left: 62, line: 'GOLD' },
            'BROOKHAVEN': { top: 16, left: 62, line: 'GOLD' },
            'LENOX': { top: 31, left: 58, line: 'GOLD' },
            
            // Shared Red/Gold Line stations
            'ARTS CENTER': { top: 46, left: 48, line: 'RED_GOLD' },
            'MIDTOWN': { top: 51, left: 48, line: 'RED_GOLD' },
            'NORTH AVENUE': { top: 56, left: 48, line: 'RED_GOLD' },
            'CIVIC CENTER': { top: 61, left: 48, line: 'RED_GOLD' },
            'PEACHTREE CENTER': { top: 66, left: 48, line: 'RED_GOLD' },
            'FIVE POINTS': { top: 72, left: 48, line: 'RED_GOLD_GREEN_BLUE' },
            'GARNETT': { top: 78, left: 48, line: 'RED_GOLD' },
            'WEST END': { top: 85, left: 42, line: 'RED_GOLD' },
            'OAKLAND CITY': { top: 90, left: 42, line: 'RED_GOLD' },
            'LAKEWOOD': { top: 95, left: 42, line: 'RED_GOLD' },
            'EAST POINT': { top: 100, left: 42, line: 'RED_GOLD' },
            'COLLEGE PARK': { top: 105, left: 42, line: 'RED_GOLD' },
            'AIRPORT': { top: 110, left: 42, line: 'RED_GOLD' },
            
            // Green Line stations (East-West)
            'BANKHEAD': { top: 72, left: 25, line: 'GREEN' },
            
            // Shared Green/Blue Line stations
            'ASHBY': { top: 72, left: 32, line: 'GREEN_BLUE' },
            'VINE CITY': { top: 72, left: 36, line: 'GREEN_BLUE' },
            'OMNI': { top: 72, left: 41, line: 'GREEN_BLUE' },
            'GEORGIA STATE': { top: 72, left: 55, line: 'GREEN_BLUE' },
            'KING MEMORIAL': { top: 72, left: 62, line: 'GREEN_BLUE' },
            'INMAN PARK': { top: 72, left: 69, line: 'GREEN_BLUE' },
            'EDGEWOOD': { top: 72, left: 76, line: 'GREEN_BLUE' },
            
            // Blue Line stations (East-West)
            'EAST LAKE': { top: 72, left: 83, line: 'BLUE' },
            'DECATUR': { top: 72, left: 90, line: 'BLUE' },
            'AVONDALE': { top: 72, left: 97, line: 'BLUE' },
            'KENSINGTON': { top: 72, left: 104, line: 'BLUE' },
            'INDIAN CREEK': { top: 72, left: 111, line: 'BLUE' }
        };

        // Create the bus map using Leaflet
        const busMap = L.map('busPositionsMap', {
            minZoom: 9,
            maxZoom: 14
        }).setView([33.749, -84.388], 10);
        let busMarkers = [];
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(busMap);

        // Set bounds for Atlanta metro area
        const atlantaBounds = L.latLngBounds(
            L.latLng(33.400, -84.950), // Southwest corner - expanded
            L.latLng(34.200, -83.900)  // Northeast corner - expanded
        );
        busMap.setMaxBounds(atlantaBounds.pad(0.1));

        // Create train map using Leaflet
        const trainMap = L.map('trainPositionsMap', {
            minZoom: 10,
            maxZoom: 14
        }).setView([33.749, -84.388], 11);
        let trainStationMarkers = {};
        let trainMarkers = [];
        
        // Add OpenStreetMap tile layer to train map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(trainMap);
        
        // Train map also uses Atlanta bounds
        trainMap.setMaxBounds(atlantaBounds.pad(0.1));
        
        // Simplified data fetching without complex libraries
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }
        
        // MARTA train station coordinates (actual GPS coordinates)
        const trainStations = {
            // Red Line stations (North-South)
            'NORTH SPRINGS': { lat: 33.9455, lng: -84.3561, lines: ['RED'] },
            'SANDY SPRINGS': { lat: 33.9321, lng: -84.3513, lines: ['RED'] },
            'DUNWOODY': { lat: 33.9212, lng: -84.3437, lines: ['RED'] },
            'MEDICAL CENTER': { lat: 33.9103, lng: -84.3515, lines: ['RED'] },
            'BUCKHEAD': { lat: 33.8465, lng: -84.3671, lines: ['RED'] },
            
            // Gold Line stations (North-South)
            'DORAVILLE': { lat: 33.9028, lng: -84.2799, lines: ['GOLD'] },
            'CHAMBLEE': { lat: 33.8879, lng: -84.3062, lines: ['GOLD'] },
            'BROOKHAVEN': { lat: 33.8600, lng: -84.3390, lines: ['GOLD'] },
            'LENOX': { lat: 33.8465, lng: -84.3566, lines: ['GOLD'] },
            
            // Shared stations for Red and Gold
            'LINDBERGH CENTER': { lat: 33.8231, lng: -84.3692, lines: ['RED', 'GOLD'] },
            'ARTS CENTER': { lat: 33.7893, lng: -84.3871, lines: ['RED', 'GOLD'] },
            'MIDTOWN': { lat: 33.7812, lng: -84.3862, lines: ['RED', 'GOLD'] },
            'NORTH AVENUE': { lat: 33.7712, lng: -84.3869, lines: ['RED', 'GOLD'] },
            'CIVIC CENTER': { lat: 33.7663, lng: -84.3872, lines: ['RED', 'GOLD'] },
            'PEACHTREE CENTER': { lat: 33.7590, lng: -84.3876, lines: ['RED', 'GOLD'] },
            'FIVE POINTS': { lat: 33.7542, lng: -84.3919, lines: ['RED', 'GOLD', 'GREEN', 'BLUE'] },
            'GARNETT': { lat: 33.7480, lng: -84.3952, lines: ['RED', 'GOLD'] },
            'WEST END': { lat: 33.7352, lng: -84.4132, lines: ['RED', 'GOLD'] },
            'OAKLAND CITY': { lat: 33.7163, lng: -84.4255, lines: ['RED', 'GOLD'] },
            'LAKEWOOD': { lat: 33.7002, lng: -84.4297, lines: ['RED', 'GOLD'] },
            'EAST POINT': { lat: 33.6768, lng: -84.4408, lines: ['RED', 'GOLD'] },
            'COLLEGE PARK': { lat: 33.6513, lng: -84.4488, lines: ['RED', 'GOLD'] },
            'AIRPORT': { lat: 33.6407, lng: -84.4444, lines: ['RED', 'GOLD'] },
            
            // Green Line stations (East-West)
            'BANKHEAD': { lat: 33.7723, lng: -84.4289, lines: ['GREEN'] },
            
            // Blue Line stations (East-West)
            'INDIAN CREEK': { lat: 33.7699, lng: -84.2291, lines: ['BLUE'] },
            'KENSINGTON': { lat: 33.7720, lng: -84.2499, lines: ['BLUE'] },
            'AVONDALE': { lat: 33.7753, lng: -84.2808, lines: ['BLUE'] },
            'DECATUR': { lat: 33.7748, lng: -84.2952, lines: ['BLUE'] },
            'EAST LAKE': { lat: 33.7650, lng: -84.3121, lines: ['BLUE'] },
            
            // Shared Green and Blue Line stations (East-West)
            'INMAN PARK': { lat: 33.7570, lng: -84.3524, lines: ['GREEN', 'BLUE'] },
            'KING MEMORIAL': { lat: 33.7501, lng: -84.3755, lines: ['GREEN', 'BLUE'] },
            'GEORGIA STATE': { lat: 33.7502, lng: -84.3863, lines: ['GREEN', 'BLUE'] },
            'OMNI': { lat: 33.7592, lng: -84.3977, lines: ['GREEN', 'BLUE'] },
            'VINE CITY': { lat: 33.7563, lng: -84.4044, lines: ['GREEN', 'BLUE'] },
            'ASHBY': { lat: 33.7562, lng: -84.4170, lines: ['GREEN', 'BLUE'] }
        };
        
        // Line colors
        const lineColors = {
            'RED': '#CE0E2D',
            'GOLD': '#FFA500',
            'BLUE': '#0000FF',
            'GREEN': '#008000'
        };
        
        // Initialize the train map with stations and route lines
        function initializeTrainMap() {
            // First add route lines
            addTrainRouteLines();
            
            // Then add station markers
            for (const [stationName, stationData] of Object.entries(trainStations)) {
                // Create marker for the station
                const marker = L.circleMarker([stationData.lat, stationData.lng], {
                    radius: 6,
                    fillColor: '#FFFFFF',
                    color: '#000000',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1
                });
                
                // Add tooltip with station name (shown on hover)
                marker.bindTooltip(stationName, {
                    permanent: false,
                    direction: 'top'
                });
                
                // Add popup with station info (shown on click)
                marker.bindPopup(`<div class="station-popup"><h5>${stationName}</h5><div class="station-trains">Loading schedule...</div></div>`);
                
                // When popup opens, fetch train data for this station
                marker.on('click', async function() {
                    updateStationPopup(marker, stationName);
                });
                
                marker.addTo(trainMap);
                trainStationMarkers[stationName] = marker;
            }
        }
        
        // Update station popup with train arrival information
        async function updateStationPopup(marker, stationName) {
            // Get the popup content element
            const popup = marker.getPopup();
            const popupContent = popup.getContent();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = popupContent;
            const trainsDiv = tempDiv.querySelector('.station-trains');
            
            // Get all train data
            const trainData = await fetchData('trains');
            
            if (trainData && trainData.length > 0) {
                // Debug output - add this to see all available trains
                console.log(`Checking for trains at ${stationName}`);
                const availableStations = new Set(trainData.map(train => train.STATION));
                console.log("Available stations in API data:", [...availableStations]);
                
                // Filter trains arriving at this station - handle different naming conventions
                const stationTrains = trainData.filter(train => {
                    // Check for exact match
                    if (train.STATION === stationName) return true;
                    
                    // Check for "STATION" suffix match
                    if (train.STATION === stationName + " STATION") return true;
                    
                    // Handle case where our data has STATION and API doesn't
                    if (stationName.includes("STATION") && train.STATION === stationName.replace(" STATION", "")) return true;
                    
                    // Handle different capitalizations
                    if (train.STATION.toUpperCase() === stationName.toUpperCase()) return true;
                    
                    // Try to normalize station names by removing "STATION" and comparing
                    const normalizedTrainStation = train.STATION.replace(" STATION", "").trim().toUpperCase();
                    const normalizedMapStation = stationName.replace(" STATION", "").trim().toUpperCase();
                    return normalizedTrainStation === normalizedMapStation;
                });
                
                // Log matched trains
                console.log(`Found ${stationTrains.length} trains for ${stationName}:`, stationTrains);
                
                if (stationTrains.length > 0) {
                    // Sort by arrival time
                    stationTrains.sort((a, b) => {
                        const timeA = a.WAITING_TIME.includes('min') 
                            ? parseInt(a.WAITING_TIME) 
                            : (a.WAITING_TIME === 'Arriving' ? 0 : 999);
                        const timeB = b.WAITING_TIME.includes('min') 
                            ? parseInt(b.WAITING_TIME) 
                            : (b.WAITING_TIME === 'Arriving' ? 0 : 999);
                        return timeA - timeB;
                    });
                    
                    // Build the train list
                    let trainsHTML = '<div class="train-list">';
                    stationTrains.forEach(train => {
                        // Determine line color class
                        let colorClass = 'bg-secondary';
                        if (train.LINE === 'RED') colorClass = 'bg-danger';
                        if (train.LINE === 'GOLD') colorClass = 'bg-warning';
                        if (train.LINE === 'BLUE') colorClass = 'bg-primary';
                        if (train.LINE === 'GREEN') colorClass = 'bg-success';
                        
                        // Format arrival time with visual indicator
                        let arrivalClass = 'arrival-waiting';
                        if (train.WAITING_TIME === 'Arriving') {
                            arrivalClass = 'arrival-now';
                        } else if (train.WAITING_TIME.includes('min')) {
                            const minutes = parseInt(train.WAITING_TIME);
                            if (minutes <= 2) {
                                arrivalClass = 'arrival-soon';
                            } else if (minutes <= 5) {
                                arrivalClass = 'arrival-approaching';
                            }
                        }
                        
                        trainsHTML += `
                            <div class="train-item">
                                <div class="train-header ${colorClass} text-white">
                                    <span>${train.LINE} Line</span>
                                    <span>Train ${train.TRAIN_ID}</span>
                                </div>
                                <div class="train-details">
                                    <div>
                                        <strong>Arrival:</strong>
                                        <span class="arrival-time ${arrivalClass}">${train.WAITING_TIME}</span>
                                    </div>
                                    <div>
                                        <strong>Destination:</strong>
                                        <span>${train.DESTINATION}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    trainsHTML += '</div>';
                    
                    trainsDiv.innerHTML = trainsHTML;
                } else {
                    trainsDiv.innerHTML = '<p class="small text-muted text-center py-2">No trains currently approaching this station.</p>';
                }
            } else {
                trainsDiv.innerHTML = '<p class="small text-muted text-center py-2">Unable to load train schedule data.</p>';
            }
            
            // Add line information
            const lines = trainStations[stationName].lines;
            const lineLabels = lines.map(line => {
                let colorClass = 'bg-secondary';
                if (line === 'RED') colorClass = 'bg-danger';
                if (line === 'GOLD') colorClass = 'bg-warning';
                if (line === 'BLUE') colorClass = 'bg-primary';
                if (line === 'GREEN') colorClass = 'bg-success';
                
                return `<span class="badge ${colorClass}">${line}</span>`;
            }).join('');
            
            trainsDiv.innerHTML = `<div class="station-lines">${lineLabels}</div>` + trainsDiv.innerHTML;
            
            // Update the popup content
            popup.setContent(tempDiv.innerHTML);
            popup.update();
        }
        
        // Add train route lines to the map
        function addTrainRouteLines() {
            // Red Line (North Springs to Airport)
            const redLineStations = [
                'NORTH SPRINGS', 'SANDY SPRINGS', 'DUNWOODY', 'MEDICAL CENTER', 'BUCKHEAD', 
                'LINDBERGH CENTER', 'ARTS CENTER', 'MIDTOWN', 'NORTH AVENUE', 'CIVIC CENTER', 
                'PEACHTREE CENTER', 'FIVE POINTS', 'GARNETT', 'WEST END', 'OAKLAND CITY', 
                'LAKEWOOD', 'EAST POINT', 'COLLEGE PARK', 'AIRPORT'
            ];
            
            // Gold Line (Doraville to Airport)
            const goldLineStations = [
                'DORAVILLE', 'CHAMBLEE', 'BROOKHAVEN', 'LENOX', 'LINDBERGH CENTER', 
                'ARTS CENTER', 'MIDTOWN', 'NORTH AVENUE', 'CIVIC CENTER', 'PEACHTREE CENTER', 
                'FIVE POINTS', 'GARNETT', 'WEST END', 'OAKLAND CITY', 'LAKEWOOD', 'EAST POINT', 
                'COLLEGE PARK', 'AIRPORT'
            ];
            
            // Green Line (Bankhead to Edgewood-Candler Park)
            const greenLineStations = [
                'BANKHEAD', 'ASHBY', 'VINE CITY', 'OMNI', 'FIVE POINTS', 'GEORGIA STATE', 
                'KING MEMORIAL', 'INMAN PARK'
            ];
            
            // Blue Line (Indian Creek to Hamilton E. Holmes)
            const blueLineStations = [
                'INDIAN CREEK', 'KENSINGTON', 'AVONDALE', 'DECATUR', 'EAST LAKE', 'INMAN PARK', 
                'KING MEMORIAL', 'GEORGIA STATE', 'FIVE POINTS', 'OMNI', 'VINE CITY', 'ASHBY'
            ];
            
            drawRouteLine(redLineStations, lineColors.RED, 5);
            drawRouteLine(goldLineStations, lineColors.GOLD, 5);
            drawRouteLine(greenLineStations, lineColors.GREEN, 5);
            drawRouteLine(blueLineStations, lineColors.BLUE, 5);
        }
        
        // Draw a train route line on the map
        function drawRouteLine(stationNames, color, weight) {
            const coordinates = stationNames.map(name => {
                if (trainStations[name]) {
                    return [trainStations[name].lat, trainStations[name].lng];
                }
                return null;
            }).filter(coord => coord !== null);
            
            if (coordinates.length >= 2) {
                const polyline = L.polyline(coordinates, {
                    color: color,
                    weight: weight,
                    opacity: 0.7
                });
                
                polyline.addTo(trainMap);
            }
        }
        
        // Custom icon for trains based on line color
        function createTrainIcon(line) {
            const color = lineColors[line] || '#999999';
            
            return L.divIcon({
                className: 'train-icon',
                html: `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });
        }

        // Update the UI with fetched data
        async function updateUI() {
            // Update weather
            const weather = await fetchData('weather');
            if (weather) {
                document.getElementById('temperature').textContent = `${weather.temperature}°F`;
                document.getElementById('conditions').textContent = weather.condition;
                document.getElementById('feelsLike').textContent = weather.feels_like;
                document.getElementById('humidity').textContent = weather.humidity;
                document.getElementById('city').textContent = weather.city;
            }

            // Update transit status
            const status = await fetchData('status');
            if (status) {
                // Bus status
                document.getElementById('busStatus').textContent = status.busStatus.status;
                document.getElementById('busDetails').textContent = status.busStatus.details;
                
                // Train status
                document.getElementById('trainStatus').textContent = status.trainStatus.status;
                document.getElementById('trainDetails').textContent = status.trainStatus.details;
                
                // Set status colors
                const busStatusEl = document.getElementById('busStatus');
                const trainStatusEl = document.getElementById('trainStatus');
                
                busStatusEl.className = '';
                trainStatusEl.className = '';
                
                if (status.busStatus.status === 'On Time') {
                    busStatusEl.classList.add('text-success');
                } else if (status.busStatus.status === 'Minor Delays') {
                    busStatusEl.classList.add('text-warning');
                } else {
                    busStatusEl.classList.add('text-danger');
                }
                
                if (status.trainStatus.status === 'On Time') {
                    trainStatusEl.classList.add('text-success');
                } else if (status.trainStatus.status === 'Minor Delays') {
                    trainStatusEl.classList.add('text-warning');
                } else {
                    trainStatusEl.classList.add('text-danger');
                }
            }

            // Update recent updates
            const updates = await fetchData('updates');
            if (updates && updates.length > 0) {
                const updatesList = document.getElementById('recentUpdates');
                updatesList.innerHTML = '';
                
                updates.forEach(update => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    
                    const dot = document.createElement('span');
                    dot.className = 'status-dot';
                    
                    if (update.type === 'on-time') {
                        dot.classList.add('status-on-time');
                    } else if (update.type === 'delayed') {
                        dot.classList.add('status-delayed');
                    } else {
                        dot.classList.add('status-disrupted');
                    }
                    
                    listItem.appendChild(dot);
                    listItem.appendChild(document.createTextNode(' ' + update.message));
                    updatesList.appendChild(listItem);
                });
            }

            // Update simple transit views
            updateTransitViews();
        }

        async function updateTransitViews() {
            // Update bus positions view
            const busData = await fetchData('buses/positions');
            const busPositionsDiv = document.getElementById('busPositions');
            busPositionsDiv.innerHTML = '';
            
            // Clear previous bus markers from the map
            busMarkers.forEach(marker => busMap.removeLayer(marker));
            busMarkers = [];
            
            if (busData && busData.entity && busData.entity.length > 0) {
                // Show all buses on the map
                busData.entity.forEach(entity => {
                    const bus = entity.vehicle;
                    if (bus && bus.position) {
                        // Only create markers for buses within Atlanta bounds
                        const busLatLng = L.latLng(bus.position.latitude, bus.position.longitude);
                        if (atlantaBounds.contains(busLatLng)) {
                            // Create a marker for the bus
                            const routeId = bus.trip?.routeId || 'Unknown';
                            const busLabel = bus.vehicle?.label || 'Unknown';
                            
                            const marker = L.marker(busLatLng);
                            marker.bindPopup(`
                                <strong>Bus ${busLabel}</strong><br>
                                Route: ${routeId}<br>
                                Position: ${bus.position.latitude.toFixed(4)}, ${bus.position.longitude.toFixed(4)}
                            `);
                            marker.addTo(busMap);
                            busMarkers.push(marker);
                        }
                    }
                });
                
                // If we have buses on the map, adjust the view to show all of them
                if (busMarkers.length > 0) {
                    // Create a feature group for buses within Atlanta bounds
                    const validMarkers = busMarkers.filter(marker => {
                        const latlng = marker.getLatLng();
                        return atlantaBounds.contains(latlng);
                    });
                    
                    if (validMarkers.length > 0) {
                        const group = new L.featureGroup(validMarkers);
                        busMap.fitBounds(group.getBounds().pad(0.1));
                    } else {
                        // If no valid markers, reset to Atlanta center
                        busMap.setView([33.749, -84.388], 10);
                    }
                }
                
                // Show up to 6 buses in detail cards
                const maxBuses = Math.min(6, busData.entity.length);
                let busesShown = 0;
                
                for (let i = 0; i < busData.entity.length && busesShown < maxBuses; i++) {
                    const bus = busData.entity[i].vehicle;
                    if (bus && bus.position) {
                        // Only show buses within Atlanta bounds
                        const busLatLng = L.latLng(bus.position.latitude, bus.position.longitude);
                        if (atlantaBounds.contains(busLatLng)) {
                            const busCard = document.createElement('div');
                            busCard.className = 'col-md-4 mb-3';
                            busCard.innerHTML = `
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Bus ${bus.vehicle?.label || 'Unknown'}</h5>
                                        <p>Route: ${bus.trip?.routeId || 'Unknown'}</p>
                                        <p>Position: ${bus.position.latitude.toFixed(4)}, ${bus.position.longitude.toFixed(4)}</p>
                                    </div>
                                </div>
                            `;
                            busPositionsDiv.appendChild(busCard);
                            busesShown++;
                        }
                    }
                }
                
                if (busesShown === 0) {
                    busPositionsDiv.innerHTML = '<p class="col-12 text-center">No bus position data available within Atlanta area</p>';
                }
            } else {
                busPositionsDiv.innerHTML = '<p class="col-12 text-center">No bus position data available</p>';
            }
            
            // Add bus trip updates
            const tripData = await fetchData('buses/trips');
            const busTripUpdatesDiv = document.getElementById('busTripUpdates');
            busTripUpdatesDiv.innerHTML = '';
            
            if (tripData && tripData.entity && tripData.entity.length > 0) {
                // Show up to 6 trip updates
                const maxTrips = Math.min(6, tripData.entity.length);
                for (let i = 0; i < maxTrips; i++) {
                    const trip = tripData.entity[i].tripUpdate;
                    if (trip) {
                        const tripCard = document.createElement('div');
                        tripCard.className = 'col-md-4 mb-3';
                        
                        // Get the next stop if available
                        let nextStopInfo = 'No stop information';
                        if (trip.stopTimeUpdate && trip.stopTimeUpdate.length > 0) {
                            const nextStop = trip.stopTimeUpdate[0];
                            const delay = nextStop.departure?.delay || nextStop.arrival?.delay || 0;
                            const delayMinutes = Math.abs(Math.round(delay / 60));
                            const delayText = delay > 0 
                                ? `<span class="badge bg-warning">${delayMinutes}m late</span>` 
                                : delay < 0 
                                    ? `<span class="badge bg-info">${delayMinutes}m early</span>`
                                    : `<span class="badge bg-success">On time</span>`;
                            
                            nextStopInfo = `
                                <p>Next stop: ${nextStop.stopId || 'Unknown'}</p>
                                <p>Status: ${delayText}</p>
                            `;
                        }
                        
                        tripCard.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Route ${trip.trip?.routeId || 'Unknown'}</h5>
                                    <p>Trip ID: ${trip.trip?.tripId || 'Unknown'}</p>
                                    ${nextStopInfo}
                                </div>
                            </div>
                        `;
                        busTripUpdatesDiv.appendChild(tripCard);
                    }
                }
            } else {
                busTripUpdatesDiv.innerHTML = '<p class="col-12 text-center">No trip update data available</p>';
            }

            // Update train positions view
            const trainData = await fetchData('trains');
            const trainPositionsDiv = document.getElementById('trainPositions');
            
            trainPositionsDiv.innerHTML = '';
            
            // Clear previous train markers
            trainMarkers.forEach(marker => trainMap.removeLayer(marker));
            trainMarkers = [];
            
            // Reset station colors
            for (const station in trainStationMarkers) {
                trainStationMarkers[station].setStyle({
                    fillColor: '#FFFFFF'
                });
            }
            
            if (trainData && trainData.length > 0) {
                // Create train markers on the map
                trainData.forEach(train => {
                    const station = train.STATION;
                    if (station) {
                        // Find the matching station in our data
                        let matchedStationName = null;
                        
                        // Try different matching approaches
                        for (const [stationName, stationData] of Object.entries(trainStations)) {
                            // Direct match
                            if (station === stationName) {
                                matchedStationName = stationName;
                                break;
                            }
                            
                            // Check for "STATION" suffix match
                            if (station === stationName + " STATION") {
                                matchedStationName = stationName;
                                break;
                            }
                            
                            // Handle case where our data has STATION and API doesn't
                            if (stationName.includes("STATION") && station === stationName.replace(" STATION", "")) {
                                matchedStationName = stationName;
                                break;
                            }
                            
                            // Try to normalize station names
                            const normalizedTrainStation = station.replace(" STATION", "").trim().toUpperCase();
                            const normalizedMapStation = stationName.replace(" STATION", "").trim().toUpperCase();
                            if (normalizedTrainStation === normalizedMapStation) {
                                matchedStationName = stationName;
                                break;
                            }
                        }
                        
                        if (matchedStationName && trainStations[matchedStationName]) {
                            // Get station coordinates
                            const stationCoords = [trainStations[matchedStationName].lat, trainStations[matchedStationName].lng];
                            
                            // Create a marker for the train
                            const trainIcon = createTrainIcon(train.LINE);
                            const marker = L.marker(stationCoords, { icon: trainIcon });
                            
                            // Format arrival time with visual indicator
                            let arrivalClass = 'arrival-waiting';
                            if (train.WAITING_TIME === 'Arriving') {
                                arrivalClass = 'arrival-now';
                            } else if (train.WAITING_TIME.includes('min')) {
                                const minutes = parseInt(train.WAITING_TIME);
                                if (minutes <= 2) {
                                    arrivalClass = 'arrival-soon';
                                } else if (minutes <= 5) {
                                    arrivalClass = 'arrival-approaching';
                                }
                            }
                            
                            // Determine line color class
                            let colorClass = 'bg-secondary';
                            if (train.LINE === 'RED') colorClass = 'bg-danger';
                            if (train.LINE === 'GOLD') colorClass = 'bg-warning';
                            if (train.LINE === 'BLUE') colorClass = 'bg-primary';
                            if (train.LINE === 'GREEN') colorClass = 'bg-success';
                            
                            // Add popup with train info
                            marker.bindPopup(`
                                <div class="station-popup">
                                    <h5>Train ${train.TRAIN_ID}</h5>
                                    <div class="station-lines">
                                        <span class="badge ${colorClass}">${train.LINE}</span>
                                    </div>
                                    <div class="train-item">
                                        <div class="train-header ${colorClass} text-white">
                                            <span>Route Info</span>
                                        </div>
                                        <div class="train-details">
                                            <div>
                                                <strong>Next Station:</strong>
                                                <span>${train.STATION}</span>
                                            </div>
                                            <div>
                                                <strong>Arrival:</strong>
                                                <span class="arrival-time ${arrivalClass}">${train.WAITING_TIME}</span>
                                            </div>
                                            <div>
                                                <strong>Destination:</strong>
                                                <span>${train.DESTINATION}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `);
                            
                            marker.addTo(trainMap);
                            trainMarkers.push(marker);
                            
                            // Highlight station with train
                            if (trainStationMarkers[matchedStationName]) {
                                trainStationMarkers[matchedStationName].setStyle({
                                    fillColor: lineColors[train.LINE] || '#FFFFFF'
                                });
                            }
                        }
                    }
                });
                
                // Show up to 6 trains in the cards below the map
                const maxTrains = Math.min(6, trainData.length);
                for (let i = 0; i < maxTrains; i++) {
                    const train = trainData[i];
                    if (train) {
                        const trainCard = document.createElement('div');
                        trainCard.className = 'col-md-4 mb-3';
                        
                        // Determine line color class
                        let colorClass = 'bg-secondary';
                        if (train.LINE === 'RED') colorClass = 'bg-danger';
                        if (train.LINE === 'GOLD') colorClass = 'bg-warning';
                        if (train.LINE === 'BLUE') colorClass = 'bg-primary';
                        if (train.LINE === 'GREEN') colorClass = 'bg-success';
                        
                        trainCard.innerHTML = `
                            <div class="card">
                                <div class="card-header ${colorClass} text-white">
                                    ${train.LINE} Line
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">Train ${train.TRAIN_ID}</h5>
                                    <p>Next station: ${train.STATION}</p>
                                    <p>Arrival: ${train.WAITING_TIME}</p>
                                    <p>Destination: ${train.DESTINATION}</p>
                                </div>
                            </div>
                        `;
                        trainPositionsDiv.appendChild(trainCard);
                    }
                }
            } else {
                trainPositionsDiv.innerHTML = '<p class="col-12 text-center">No train data available</p>';
            }
        }

        // Toggle between bus and train views
        document.getElementById('showBuses').addEventListener('click', function() {
            document.getElementById('busView').style.display = 'block';
            document.getElementById('trainView').style.display = 'none';
            document.getElementById('showBuses').classList.add('active');
            document.getElementById('showTrains').classList.remove('active');
            // Resize map after showing it (needed for proper rendering)
            busMap.invalidateSize();
        });

        document.getElementById('showTrains').addEventListener('click', function() {
            document.getElementById('busView').style.display = 'none';
            document.getElementById('trainView').style.display = 'block';
            document.getElementById('showBuses').classList.remove('active');
            document.getElementById('showTrains').classList.add('active');
            // Initialize train map if first time viewing
            if (Object.keys(trainStationMarkers).length === 0) {
                initializeTrainMap();
            }
            // Resize map after showing it (needed for proper rendering)
            trainMap.invalidateSize();
        });

        // Handle refresh buttons
        document.getElementById('refreshBtn').addEventListener('click', updateUI);
        document.getElementById('refreshUpdates').addEventListener('click', async function() {
            const updates = await fetchData('updates');
            if (updates && updates.length > 0) {
                const updatesList = document.getElementById('recentUpdates');
                updatesList.innerHTML = '';
                
                updates.forEach(update => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    
                    const dot = document.createElement('span');
                    dot.className = 'status-dot';
                    
                    if (update.type === 'on-time') {
                        dot.classList.add('status-on-time');
                    } else if (update.type === 'delayed') {
                        dot.classList.add('status-delayed');
                    } else {
                        dot.classList.add('status-disrupted');
                    }
                    
                    listItem.appendChild(dot);
                    listItem.appendChild(document.createTextNode(' ' + update.message));
                    updatesList.appendChild(listItem);
                });
            }
        });

        // Initial data load
        updateUI();
        
        // Refresh data every 30 seconds
        setInterval(updateUI, 30000);
    </script>
</body>
</html>
        